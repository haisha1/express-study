# 用户管理 API 接口文档

## 概述

用户管理模块提供了完整的用户CRUD（增删改查）功能和用户登录功能。所有用户密码都使用 bcryptjs 进行加密存储，确保安全性。

## 基础信息

- **基础路径**: `/users`
- **数据格式**: JSON
- **密码加密**: 使用 bcryptjs，加密强度为10轮

## 用户字段说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | Integer | 自动生成 | 用户ID（主键） |
| email | String | 是 | 用户邮箱（唯一） |
| username | String | 是 | 用户名（唯一，2-45字符） |
| password | String | 是 | 密码（6-45字符，自动加密存储） |
| nickname | String | 是 | 昵称（2-45字符） |
| sex | Integer | 是 | 性别（0=男性，1=女性，2=未选择） |
| company | String | 否 | 公司名称 |
| introduce | Text | 否 | 个人介绍 |
| role | Integer | 是 | 用户角色（0=普通用户，100=管理员） |
| avatar | String | 否 | 头像URL |

## API 接口列表

### 1. 用户登录

**接口地址**: `POST /users/login`

**功能描述**: 用户登录验证

**请求参数**:
- email: 用户邮箱
- password: 用户密码

**请求示例**:
```bash
POST /users/login
Content-Type: application/json

{
  "email": "admin@clwy.cn",
  "password": "123123"
}
```

**响应示例**:
```json
{
  "status": true,
  "message": "登录成功",
  "data": {
    "user": {
      "id": 1,
      "email": "admin@clwy.cn",
      "username": "admin",
      "nickname": "超厉害的管理员",
      "sex": 2,
      "role": 100,
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    }
  }
}
```

### 2. 查询用户列表

**接口地址**: `GET /users`

**功能描述**: 获取用户列表，支持分页和搜索

**请求参数**:
- currentPage: 当前页码，默认1
- pageSize: 每页数量，默认10
- username: 用户名关键词搜索
- email: 邮箱关键词搜索
- role: 用户角色筛选

**响应示例**:
```json
{
  "status": true,
  "message": "查询用户列表成功。",
  "data": {
    "users": [...],
    "pagination": {
      "total": 1,
      "currentPage": 1,
      "pageSize": 10
    }
  }
}
```

### 3. 查询用户详情

**接口地址**: `GET /users/:id`

**功能描述**: 根据用户ID获取用户详细信息

### 4. 创建用户

**接口地址**: `POST /users`

**功能描述**: 创建新用户（密码会自动加密）

### 5. 更新用户

**接口地址**: `PUT /users/:id`

**功能描述**: 更新指定用户的信息（如果更新密码会自动加密）

### 6. 删除用户

**接口地址**: `DELETE /users/:id`

**功能描述**: 删除指定用户

## 密码安全特性

### 1. 自动加密
- 创建用户时，密码会自动使用 bcryptjs 加密
- 更新用户密码时，也会自动加密
- 加密强度为10轮，平衡安全性和性能

### 2. 密码验证
- 登录时使用 `bcrypt.compare()` 验证密码
- 不会在数据库中存储明文密码
- 即使数据库被泄露，密码也无法被破解

### 3. 安全响应
- 所有API响应都自动排除密码字段
- 保护用户隐私，防止密码泄露

## 测试数据

系统预置了以下测试用户（密码已加密）：

| 用户名 | 邮箱 | 角色 | 说明 |
|--------|------|------|------|
| admin | admin@clwy.cn | 管理员 | 系统管理员 |
| user1 | user1@clwy.cn | 普通用户 | 测试用户1 |
| user2 | user2@clwy.cn | 普通用户 | 测试用户2 |
| user3 | user3@clwy.cn | 普通用户 | 测试用户3 |

**登录测试**:
```bash
# 管理员登录
POST /users/login
{
  "email": "admin@clwy.cn",
  "password": "123123"
}

# 普通用户登录
POST /users/login
{
  "email": "user1@clwy.cn", 
  "password": "123123"
}
```

## 错误处理

### 登录错误
```json
{
  "status": false,
  "message": "登录失败",
  "errors": ["邮箱或密码错误"]
}
```

### 参数错误
```json
{
  "status": false,
  "message": "邮箱和密码不能为空",
  "errors": ["请提供邮箱和密码"]
}
```

## 错误响应

### 常见错误码

| HTTP状态码 | 错误类型 | 说明 |
|------------|----------|------|
| 400 | SequelizeValidationError | 数据验证失败 |
| 404 | NotFoundError | 用户不存在 |
| 500 | 服务器错误 | 内部服务器错误 |

### 错误响应格式

```json
{
  "status": false,
  "message": "错误消息",
  "errors": ["具体错误详情"]
}
```

### 错误响应示例

**数据验证失败**:
```json
{
  "status": false,
  "message": "请求参数错误",
  "errors": [
    "邮箱格式不正确。",
    "用户名长度必须是2 ~ 45之间。"
  ]
}
```

**用户不存在**:
```json
{
  "status": false,
  "message": "资源不存在",
  "errors": ["ID: 999的用户未找到。"]
}
```

## 数据验证规则

### 邮箱验证
- 必填
- 格式必须为有效邮箱
- 必须唯一

### 用户名验证
- 必填
- 长度2-45字符
- 必须唯一

### 密码验证
- 必填
- 长度6-45字符

### 昵称验证
- 必填
- 长度2-45字符

### 性别验证
- 必填
- 值必须是：0（男性）、1（女性）、2（未选择）

### 角色验证
- 必填
- 值必须是：0（普通用户）、100（管理员）

### 头像验证
- 可选
- 必须是有效的URL格式

## 安全注意事项

1. **密码安全**: 实际项目中密码应该加密存储
2. **权限控制**: 建议添加权限验证，只有管理员才能管理用户
3. **数据过滤**: 查询时自动排除密码字段，保护用户隐私
4. **输入验证**: 所有输入都经过严格验证，防止恶意数据

## 测试数据

系统预置了以下测试用户：

| 用户名 | 邮箱 | 角色 | 说明 |
|--------|------|------|------|
| admin | admin@clwy.cn | 管理员 | 系统管理员 |
| user1 | user1@clwy.cn | 普通用户 | 测试用户1 |
| user2 | user2@clwy.cn | 普通用户 | 测试用户2 |
| user3 | user3@clwy.cn | 普通用户 | 测试用户3 |

所有测试用户的密码都是：`123123` 